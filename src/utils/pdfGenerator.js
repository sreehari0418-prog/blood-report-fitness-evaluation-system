import jsPDF from 'jspdf';
import 'jspdf-autotable';

export const generateReportPDF = (user, bloodReports, healthNotes) => {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();

    // Header
    doc.setFontSize(22);
    doc.setTextColor(41, 128, 185); // Blue
    doc.text("Blood Report & Fitness Evaluation", pageWidth / 2, 20, { align: 'center' });

    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, 28, { align: 'center' });

    // User Profile Section
    doc.setDrawColor(200);
    doc.line(14, 35, pageWidth - 14, 35);

    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text("User Profile", 14, 45);

    doc.setFontSize(11);
    doc.setTextColor(80);
    doc.text(`Name: ${user.name || 'N/A'}`, 14, 55);
    doc.text(`Age: ${user.age || '-'}  |  Gender: ${user.gender || '-'}`, 14, 62);
    doc.text(`Height: ${user.height || '-'} cm  |  Weight: ${user.weight || '-'} kg`, 14, 69);
    doc.text(`Blood Group: ${user.bloodGroup || '-'}`, 14, 76);

    // Health Notes
    if (healthNotes) {
        doc.text(`Conditions: ${healthNotes.conditions || 'None'}`, 14, 86);
        doc.text(`Allergies: ${healthNotes.allergies || 'None'}`, 14, 93);
    }

    // Reports Table
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text("Recent Blood Reports", 14, 110);

    if (bloodReports && bloodReports.length > 0) {
        const tableData = [];

        // Flatten reports - let's just show a summary of the latest report for detailed columns
        // Or a list of reports with date and status? 
        // Let's do a Detailed Table for the LATEST report

        const latestReport = bloodReports[0];
        doc.setFontSize(10);
        doc.text(`Latest Report Date: ${latestReport.date}`, 14, 118);

        if (latestReport.results) {
            latestReport.results.forEach(res => {
                tableData.push([
                    res.parameter.toUpperCase(),
                    `${res.value} ${res.unit}`,
                    res.range,
                    res.status
                ]);
            });

            doc.autoTable({
                startY: 125,
                head: [['Parameter', 'Value', 'Ref Range', 'Status']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] },
                alternateRowStyles: { fillColor: [240, 248, 255] },
                didParseCell: function (data) {
                    if (data.column.index === 3) {
                        const cell = data.cell;
                        if (cell.raw === 'High') cell.styles.textColor = [220, 20, 60];
                        if (cell.raw === 'Low') cell.styles.textColor = [218, 165, 32];
                        if (cell.raw === 'Normal') cell.styles.textColor = [0, 128, 0];
                    }
                }
            });
        }
    } else {
        doc.setFontSize(11);
        doc.setTextColor(150);
        doc.text("No reports found.", 14, 120);
    }

    // Footer
    const pageHeight = doc.internal.pageSize.getHeight();
    doc.setFontSize(10);
    doc.setTextColor(150);
    doc.text("Generated by AI Health Assistant", 14, pageHeight - 10);

    doc.save(`Health_Report_${user.name || 'User'}.pdf`);
};
